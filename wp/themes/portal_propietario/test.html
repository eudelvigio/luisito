<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.9.0/viewer.min.js" integrity="sha512-0goo56vbVLOJt9J6TMouBm2uE+iPssyO+70sdrT+J5Xbb5LsdYs31Mvj4+LntfPuV+VlK0jcvcinWQG5Hs3pOg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.js" integrity="sha512-d9xgZrVZpmmQlfonhQUvTR7lMPtO7NkZMkA0ABN3PHCbKA5nqylQ/yWlFAyY6hYgdF1Qh6nYiuADWwKB4C2WSw==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment-with-locales.min.js" integrity="sha512-LGXaggshOkD/at6PFNcp2V2unf9LzFq6LE+sChH7ceMTDP0g2kn6Vxwgg7wkPP7AAtX+lmPqPdxB47A0Nz0cMQ==" crossorigin="anonymous"></script>
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.9.0/viewer.min.css" integrity="sha512-1cfqrTRQ8V1TnQsSu97+x7PoylALHKOQuwpFaa6lwe6lo5EOUmGNmX3LBq/yxUokfGaUtWkjZJGmuXqG5THgdA==" crossorigin="anonymous" />
    <style>
        body {
            font-family: 'Roboto', sans-serif;
        }
        
        .wrapper {
            display: flex;
            width: 1200px;
            margin: 0 auto;
            padding: 20px;
            border: 1px solid #ccc;
        }
        
        .wrapper #graph-wrapper {
            width: 600px;
            position: relative;
        }
        
        .wrapper #msgs {
            flex-grow: 1;
            display: flex;
            flex-flow: column;
        }
        
        .wrapper #msgs #msg-list {
            display: flex;
            flex-flow: column-reverse;
            height: 250px;
            overflow: auto;
        }
        
        .wrapper #msgs #msg-list .msg-wrapper {
            border: 1px solid #000;
            margin: 5px;
            padding: 5px;
            height: 50px;
        }
        
        .wrapper #msgs #msg-list .msg-wrapper .date {
            font-size: 10px;
            color: gray;
        }
        
        .wrapper #msgs #form {
            margin-top: auto;
            display: flex;
            align-items: center;
        }
        
        .wrapper #msgs #form textarea {
            width: 80%;
            height: 40px;
        }
        
        .wrapper #msgs #form button {
            width: 20%;
            height: 40px;
        }
        
        #photos #gallery {
            display: flex;
            width: 1200px;
            margin: 0 auto;
            flex-wrap: wrap;
        }
        
        #photos #gallery li {
            list-style: none;
        }
        
        #photos #gallery img {
            width: 200px;
            margin: 20px;
        }
    </style>

</head>

<body>
    <div class="wrapper">
        <div id="graph-wrapper">
            <canvas id="graph"></canvas>
        </div>
        <div id="msgs">
            <div id="msg-list"></div>
            <div id="form">
                <textarea id="txt"></textarea>
                <button onclick="writeText()">Enviar</button>
            </div>
        </div>
    </div>
    <div id="photos">
        <ul id="gallery">

        </ul>
    </div>
    <script>
        moment.locale("es");

        function updateChart() {
            fetch("/data.php?action=read")
                .then(r => r.json())
                .then(res => {
                    var fechas = res.map(r => moment(r.date + "Z").format("HH:mm")).reverse();
                    var hums = res.map(r => r.hum).reverse();
                    var temps = res.map(r => r.temp).reverse();
                    var ctx = document.getElementById('graph').getContext('2d');
                    var myLineChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: fechas,
                            datasets: [{
                                label: 'Temperatura',
                                borderColor: '#f00',
                                data: temps
                            }, {
                                label: 'Humedad',
                                borderColor: '#00f',
                                data: hums
                            }]
                        },
                        options: {
                            tooltips: {
                                mode: 'index',
                                intersect: false,
                            },
                            hover: {
                                mode: 'nearest',
                                intersect: true
                            },
                        }
                    });
                });
        }

        function updateText() {
            fetch("/data.php?action=read-msg")
                .then(r => r.json())
                .then(res => {
                    res.forEach(t => {
                        var html = `
                          <div class="msg-wrapper">
                            <div class="date">${moment(t.date + "Z").fromNow()}</div>
                            <div class="txt">${t.txt}</div>
                          </div>
                        `;

                        document.getElementById("msg-list").innerHTML += html;
                    });
                });
        }

        function updateImages() {
            fetch("/data.php?action=get-photos")
                .then(r => r.json())
                .then(res => {
                    res.forEach(t => {
                        var html = `
                          <li class="photo-wrapper">
                            <img src="${t.file}" alt="${moment(t.created + "Z").fromNow()}" />
                          </li>
                        `;

                        document.getElementById("gallery").innerHTML += html;
                    });

                    const gallery = new Viewer(document.getElementById('gallery'));


                });
        }

        updateChart();
        updateText();
        updateImages();


        function writeText() {
            var txt = document.getElementById("txt").value;
            var fd = new FormData();
            fd.append("txt", txt);
            fetch("/data.php?action=write-msg", {
                    method: "POST",
                    body: fd
                })
                .then(res => res.text())
                .then(res => window.location.reload());
        }
    </script>
</body>

</html>